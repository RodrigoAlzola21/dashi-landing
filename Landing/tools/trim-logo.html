<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recortar logo Dashi (PNG)</title>
  <style>
    :root {
      --bg: #0b0b0c;
      --panel: #151518;
      --text: #f5f5f7;
      --muted: #b2b2b8;
      --accent: #e11d2e;
      --border: rgba(255, 255, 255, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Segoe UI", Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 20% 10%, rgba(225, 29, 46, 0.08), transparent 35%),
        linear-gradient(180deg, #080809, #0b0b0c);
      padding: 20px;
    }

    .wrap {
      max-width: 980px;
      margin: 0 auto;
      display: grid;
      gap: 16px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 1.15rem;
    }

    p {
      margin: 0;
      color: var(--muted);
      line-height: 1.5;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
    }

    .canvas-box {
      display: grid;
      gap: 10px;
    }

    .canvas-title {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .canvas-frame {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background:
        linear-gradient(45deg, rgba(255,255,255,0.03) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.03) 75%),
        linear-gradient(45deg, rgba(255,255,255,0.03) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.03) 75%);
      background-size: 20px 20px;
      background-position: 0 0, 10px 10px;
      min-height: 220px;
      display: grid;
      place-items: center;
      overflow: auto;
    }

    canvas {
      max-width: 100%;
      height: auto;
      display: block;
      background: transparent;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    button {
      appearance: none;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 11px 14px;
      background: linear-gradient(145deg, #e11d2e, #b3121f);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .status {
      color: var(--muted);
      font-size: 0.9rem;
      min-height: 1.4em;
    }

    .meta {
      font-family: Consolas, monospace;
      font-size: 0.82rem;
      color: #d5d5db;
      white-space: pre-wrap;
    }

    @media (max-width: 760px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="panel">
      <h1>Recorte automatico de logo PNG (alpha trim)</h1>
      <p>
        Carga automaticamente <code>../assets/dashi-logo.png</code>, detecta el contenido visible (alpha &gt; 0),
        recorta el espacio transparente y permite descargar el resultado como <code>dashi-logo-cropped.png</code>.
      </p>
    </section>

    <section class="panel grid">
      <div class="canvas-box">
        <div class="canvas-title">Original</div>
        <div class="canvas-frame">
          <canvas id="sourceCanvas" aria-label="Preview del logo original"></canvas>
        </div>
      </div>

      <div class="canvas-box">
        <div class="canvas-title">Recortado</div>
        <div class="canvas-frame">
          <canvas id="trimmedCanvas" aria-label="Preview del logo recortado"></canvas>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="actions">
        <button id="downloadBtn" type="button" disabled>Descargar PNG recortado</button>
        <div id="status" class="status" aria-live="polite">Cargando logo...</div>
      </div>
      <pre id="meta" class="meta"></pre>
    </section>
  </main>

  <script>
    const SOURCE_PATH = "../assets/dashi-logo.png";
    const DOWNLOAD_NAME = "dashi-logo-cropped.png";

    const sourceCanvas = document.getElementById("sourceCanvas");
    const trimmedCanvas = document.getElementById("trimmedCanvas");
    const sourceCtx = sourceCanvas.getContext("2d");
    const trimmedCtx = trimmedCanvas.getContext("2d");
    const downloadBtn = document.getElementById("downloadBtn");
    const statusEl = document.getElementById("status");
    const metaEl = document.getElementById("meta");

    let trimmedReady = false;

    function setStatus(message, isError) {
      statusEl.textContent = message;
      statusEl.style.color = isError ? "#ff7a7a" : "";
    }

    function drawImageToCanvas(canvas, ctx, image, sx = 0, sy = 0, sw = image.width, sh = image.height) {
      canvas.width = sw;
      canvas.height = sh;
      ctx.clearRect(0, 0, sw, sh);
      ctx.drawImage(image, sx, sy, sw, sh, 0, 0, sw, sh);
    }

    function findAlphaBounds(imageData) {
      const { data, width, height } = imageData;
      let minX = width;
      let minY = height;
      let maxX = -1;
      let maxY = -1;

      for (let y = 0; y < height; y += 1) {
        for (let x = 0; x < width; x += 1) {
          const alpha = data[(y * width + x) * 4 + 3];
          if (alpha > 0) {
            if (x < minX) minX = x;
            if (y < minY) minY = y;
            if (x > maxX) maxX = x;
            if (y > maxY) maxY = y;
          }
        }
      }

      if (maxX < 0 || maxY < 0) {
        return null;
      }

      return {
        x: minX,
        y: minY,
        width: maxX - minX + 1,
        height: maxY - minY + 1
      };
    }

    function loadAndTrimLogo() {
      const img = new Image();
      img.onload = () => {
        try {
          drawImageToCanvas(sourceCanvas, sourceCtx, img);
          const sourceData = sourceCtx.getImageData(0, 0, sourceCanvas.width, sourceCanvas.height);
          const bounds = findAlphaBounds(sourceData);

          if (!bounds) {
            setStatus("No se detectaron pixeles visibles (alpha > 0).", true);
            metaEl.textContent = "";
            downloadBtn.disabled = true;
            trimmedReady = false;
            return;
          }

          // Recorta usando el bounding box de pixeles con alpha > 0.
          trimmedCanvas.width = bounds.width;
          trimmedCanvas.height = bounds.height;
          trimmedCtx.clearRect(0, 0, bounds.width, bounds.height);
          trimmedCtx.drawImage(
            sourceCanvas,
            bounds.x,
            bounds.y,
            bounds.width,
            bounds.height,
            0,
            0,
            bounds.width,
            bounds.height
          );

          trimmedReady = true;
          downloadBtn.disabled = false;
          setStatus("Logo cargado y recortado. Listo para descargar.", false);

          metaEl.textContent =
            `Original: ${img.width}x${img.height}px\n` +
            `Recorte: x=${bounds.x}, y=${bounds.y}, w=${bounds.width}, h=${bounds.height}\n` +
            `Resultado: ${trimmedCanvas.width}x${trimmedCanvas.height}px`;
        } catch (error) {
          trimmedReady = false;
          downloadBtn.disabled = true;
          setStatus("No se pudo procesar el PNG en canvas. Si abriste por file:// y falla por seguridad, usa otro navegador.", true);
          metaEl.textContent = String(error);
        }
      };

      img.onerror = () => {
        trimmedReady = false;
        downloadBtn.disabled = true;
        setStatus(`No se pudo cargar ${SOURCE_PATH}. Verifica que el archivo exista.`, true);
        metaEl.textContent = "";
      };

      img.src = SOURCE_PATH;
    }

    downloadBtn.addEventListener("click", () => {
      if (!trimmedReady) return;

      const a = document.createElement("a");
      a.href = trimmedCanvas.toDataURL("image/png");
      a.download = DOWNLOAD_NAME;
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    loadAndTrimLogo();
  </script>
</body>
</html>
